/**
 * AngularGM - Google Maps Directives for AngularJS
 * @version v1.0.0 - 2014-01-02
 * @link http://dylanfprice.github.com/angular-gm
 * @author Dylan Price <the.dylan.price@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){"use strict";angular.module("AngularGM",[]).factory("angulargmDefaults",function(){return{precision:3,markerConstructor:google.maps.Marker,polylineConstructor:google.maps.Polyline,mapOptions:{zoom:8,center:new google.maps.LatLng(46,-120),mapTypeId:google.maps.MapTypeId.ROADMAP}}})}(),function(){"use strict";angular.module("AngularGM").directive("gmInfoWindow",["$parse","$compile","$timeout","angulargmUtils",function(a,b,c,d){function e(b,d,e){var g=angular.extend({},b.$eval(e.gmInfoWindowOptions));g.content=d[0];var h=a(e.gmInfoWindow),i=h(b);i||(i=new google.maps.InfoWindow(g),h.assign(b,i));var j=f(e);angular.forEach(j,function(a,d){google.maps.event.addListener(i,d,function(){c(function(){a(b,{infoWindow:i})})})}),d.replaceWith("<div></div>");var k=i.open;i.open=function(a,b){k.call(i,a,b)}}var f=d.getEventHandlers;return{restrict:"A",priority:100,scope:!1,link:e}}])}(),function(){"use strict";angular.module("AngularGM").directive("gmMap",["$timeout","angulargmUtils",function(a,b){function c(b,c,e,f){if(angular.isDefined(b.gmCenter)||(b.center={}),angular.isDefined(b.gmBounds)||(b.bounds={}),!angular.isDefined(b.gmMapId))throw"angulargm must have non-empty gmMapId attribute";var g=!1,h=!1,i=!1,j=!1;e.hasOwnProperty("gmCenter")&&(g=!0),e.hasOwnProperty("gmZoom")&&(h=!0),e.hasOwnProperty("gmBounds")&&(i=!0),e.hasOwnProperty("gmMapTypeId")&&(j=!0);var k=function(){a(function(){(g||h||i||j)&&b.$apply(function(){if(g&&(b.gmCenter=f.center),h&&(b.gmZoom=f.zoom),i){var a=f.bounds;a&&(b.gmBounds=a)}j&&(b.gmMapTypeId=f.mapTypeId)})})};f.addMapListener("drag",k),f.addMapListener("zoom_changed",k),f.addMapListener("center_changed",k),f.addMapListener("bounds_changed",k),f.addMapListener("maptypeid_changed",k),f.addMapListener("resize",k);var l=f.getMap(e.gmMapId),m=d(e);angular.forEach(m,function(c,d){f.addMapListener(d,function(d){var e={map:l};void 0!==d&&(e.event=d),a(function(){c(b.$parent,e)})})}),g&&b.$watch("gmCenter",function(a,b){var c=a!==b;if(c&&!f.dragging){var d=a;d&&(f.center=d)}},!0),h&&b.$watch("gmZoom",function(a,b){var c=null!=a&&!isNaN(a);c&&a!==b&&(f.zoom=a)}),i&&b.$watch("gmBounds",function(a,b){var c=a!==b;if(c&&!f.dragging){var d=a;d&&(f.bounds=d)}}),j&&b.$watch("gmMapTypeId",function(a,b){var c=a!==b;c&&a&&(f.mapTypeId=a)}),b.$on("gmMapResize",function(a,c){b.gmMapId()===c&&f.mapTrigger("resize")}),f.addMapListenerOnce("idle",function(){b.$emit("gmMapIdle",b.gmMapId())}),f.mapTrigger("resize")}var d=b.getEventHandlers;return{restrict:"AE",priority:100,template:'<div><div id="" style="width:100%;height:100%;"></div><div ng-transclude></div></div>',transclude:!0,replace:!0,scope:{gmCenter:"=",gmZoom:"=",gmBounds:"=",gmMapTypeId:"=",gmMapOptions:"&",gmMapId:"&"},controller:"angulargmMapController",link:c}}])}(),function(){"use strict";angular.module("AngularGM").directive("gmMarkers",["$log","$parse","$timeout","angulargmUtils","angulargmShape",function(a,b,c,d,e){function f(a,b,c,d){if(!("gmPosition"in c))throw"gmPosition attribute required";var f=function(b){var c=a.gmPosition({object:b}),d=g(c);if(null==d)return null;var e=a.gmMarkerOptions({object:b}),f={};return angular.extend(f,e,{position:d}),f};e.createShapeDirective("marker",a,c,d,f)}var g=d.objToLatLng;return{restrict:"AE",priority:100,scope:{gmObjects:"&",gmId:"&",gmPosition:"&",gmMarkerOptions:"&",gmEvents:"&"},require:"^gmMap",link:f}}])}(),function(){"use strict";angular.module("AngularGM").directive("gmPolylines",["$parse","$compile","$timeout","$log","angulargmUtils","angulargmShape",function(a,b,c,d,e,f){function g(a,b,c,e){if(!("gmPath"in c))throw"gmPath attribute required";var g=function(b){var c=a.gmPath({object:b}),e=[];angular.forEach(c,function(a){var b=h(a);return null==b?(d.warn("Unable to generate lat/lng from ",a),void 0):(e.push(b),void 0)});var f=a.gmPolylineOptions({object:b}),g={};return angular.extend(g,f,{path:e}),g};f.createShapeDirective("polyline",a,c,e,g)}var h=e.objToLatLng;return{restrict:"AE",priority:100,scope:{gmObjects:"&",gmId:"&",gmPath:"&",gmPolylineOptions:"&",gmEvents:"&"},require:"^gmMap",link:g}}])}(),function(){"use strict";angular.module("AngularGM").factory("angulargmContainer",["$q",function(a){function b(a,b){if(!(b instanceof google.maps.Map))throw"map not a google.maps.Map: "+b;if(a in g)throw"already contain map with id "+a;g[a]=b,a in h&&h[a].resolve(b)}function c(a){return g[a]}function d(b){var c=h[b]||a.defer();return h[b]=c,c.promise}function e(a){a in g&&delete g[a],a in h&&delete h[a]}function f(){g={},h={}}var g={},h={};return{addMap:b,getMap:c,getMapPromise:d,removeMap:e,clear:f}}])}(),function(){"use strict";angular.module("AngularGM").factory("angulargmShape",["$timeout","angulargmUtils",function(a,b){function c(a){if(!("gmObjects"in a))throw"gmObjects attribute required";if(!("gmId"in a))throw"gmId attribute required"}function d(a,b){var c={};return angular.forEach(b,function(b){var d=a.gmId({object:b});c[d]=b}),c}function e(b,c,d,e,f,g){angular.forEach(f,function(f,h){var i=d.getElement(b,c.$id,h),j=g(f);null!=j&&(i?d.updateElement(b,c.$id,h,j):(d.addElement(b,c.$id,h,j),i=d.getElement(b,c.$id,h),angular.forEach(e,function(e,g){d.addListener(i,g,function(){a(function(){var a={object:f};a[b]=i,e(c.$parent.$parent,a)})})})))})}function f(a,b,c,d){var e=[];c.forEachElementInScope(a,b.$id,function(a,b){b in d||e.push(b)}),angular.forEach(e,function(d){c.removeElement(a,b.$id,d)})}function g(a,b){var c=b.charAt(0).toUpperCase()+b.slice(1)+"s";return a.replace("Shapes",c)}function h(b,c,d,e,f){c.$watch("gmObjects().length",function(a,b){null!=a&&a!==b&&f(c,c.gmObjects())}),c.$watch("gmObjects()",function(a,b){null!=a&&a!==b&&f(c,c.gmObjects())}),c.$watch("gmEvents()",function(d,f){null!=d&&d!==f&&angular.forEach(d,function(d){var f=d.event,g=d.ids;angular.forEach(g,function(d){var g=e.getElement(b,c.$id,d);null!=g&&a(angular.bind(this,e.trigger,g,f))})})}),c.$on(g("gmShapesRedraw",b),function(a,b){(null==b||b===d.gmObjects)&&(f(c),f(c,c.gmObjects()))}),c.$on(g("gmShapesUpdate",b),function(a,b){(null==b||b===d.gmObjects)&&f(c,c.gmObjects())})}function i(i,j,k,l,m){c(k);var n=function(a,c){var h=d(a,c),j=b.getEventHandlers(k);e(i,a,l,j,h,m),f(i,a,l,h),a.$emit(g("gmShapesUpdated",i),k.gmObjects)};h(i,j,k,l,n),a(angular.bind(null,n,j,j.gmObjects()))}return{createShapeDirective:i}}])}(),function(){"use strict";angular.module("AngularGM").factory("angulargmUtils",["$parse",function(a){function b(a,b){return Math.abs(a-b)<1e-6}function c(a,c){return a instanceof google.maps.LatLng&&c instanceof google.maps.LatLng?b(a.lat(),c.lat())&&b(a.lng(),c.lng()):!1}function d(a,b){if(!(a instanceof google.maps.LatLngBounds&&b instanceof google.maps.LatLngBounds))return!1;var d=a.getSouthWest(),e=b.getSouthWest(),f=a.getNorthEast(),g=b.getNorthEast();return c(d,e)&&c(f,g)}function e(a){if(!(a instanceof google.maps.LatLng))throw"latLng not a google.maps.LatLng";return{lat:a.lat(),lng:a.lng()}}function f(a){if(null!=a){var b=a.lat,c=a.lng,d=!(null==b||null==c||isNaN(b)||isNaN(c));if(d)return new google.maps.LatLng(b,c)}return null}function g(a){if(!(a instanceof google.maps.LatLng))throw"latLng must be a google.maps.LatLng";var b=null==a.lat()||null==a.lng(),c=isNaN(a.lat())||isNaN(a.lng());return b||c}function h(b){var c={};return angular.forEach(b,function(b,d){if(0===d.lastIndexOf("gmOn",0)){var e=angular.lowercase(d.substring(4).replace(/(?!^)([A-Z])/g,"_$&")),f=a(b);c[e]=f}}),c}function i(a,b){if(void 0===a||null===a)throw b?b+" was: "+a:"value was: "+a}return{latLngEqual:c,boundsEqual:d,latLngToObj:e,objToLatLng:f,hasNaN:g,getEventHandlers:h,assertDefined:i}}])}(),function(){"use strict";angular.module("AngularGM").controller("angulargmMapController",["$scope","$element","angulargmUtils","angulargmDefaults","angulargmContainer",function(a,b,c,d,e){var f=c.latLngEqual,g=c.boundsEqual,h=c.hasNaN,i=c.assertDefined,j=function(a,b){var c=a.gmMapId();if(!c)throw"angulargm must have non-empty gmMapId attribute";var i=angular.element(b[0].firstChild);i.attr("id",c);var j=this._getConfig(a,d);this._map=this._createMap(c,i,j,e,a),this._elements={},this._listeners={},this.dragging=!1,Object.defineProperties(this,{precision:{value:d.precision,writeable:!1},center:{configurable:!0,get:function(){return this._map.getCenter()},set:function(a){if(h(a))throw"center contains null or NaN";var b=!f(this.center,a);b&&this._map.panTo(a)}},zoom:{configurable:!0,get:function(){return this._map.getZoom()},set:function(a){if(null==a||isNaN(a))throw"zoom was null or NaN";var b=this.zoom!==a;b&&this._map.setZoom(a)}},bounds:{configurable:!0,get:function(){return this._map.getBounds()},set:function(a){var b=!h(a.getSouthWest())&&!h(a.getNorthEast());if(!b)throw"bounds contains null or NaN";var c=!g(this.bounds,a);c&&this._map.fitBounds(a)}},mapTypeId:{configurable:!0,get:function(){return this._map.getMapTypeId()},set:function(a){if(null==a)throw"mapTypeId was null or unknown";var b=this.mapTypeId!==a;b&&this._map.setMapTypeId(a)}}}),this._initDragListeners(),a.$on("$destroy",angular.bind(this,this._destroy))};this._getConfig=function(a,b){var c=b.mapOptions,d={};return angular.extend(d,c,a.gmMapOptions()),d},this._createMap=function(a,b,c,d){var e=d.getMap(a);if(e){var f=e.getDiv();b.replaceWith(f),this._map=e,this.mapTrigger("resize"),e.setOptions(c)}else e=new google.maps.Map(b[0],c),d.addMap(a,e);return e},this._initDragListeners=function(){var a=this;this.addMapListener("dragstart",function(){a.dragging=!0}),this.addMapListener("idle",function(){a.dragging=!1}),this.addMapListener("drag",function(){a.dragging=!0})},this._destroy=function(){angular.forEach(this._listeners,function(a){angular.forEach(a,function(a){google.maps.event.removeListener(a)})}),this._listeners={};var a=this,b=Object.keys(this._elements);angular.forEach(b,function(b){var c=Object.keys(a._getElements(b));angular.forEach(c,function(c){a.forEachElementInScope(b,c,function(d,e){a.removeElement(b,c,e)})})})},this.addMapListener=function(a,b){var c=google.maps.event.addListener(this._map,a,b);void 0===this._listeners[a]&&(this._listeners[a]=[]),this._listeners[a].push(c)},this.addMapListenerOnce=function(a,b){google.maps.event.addListenerOnce(this._map,a,b)},this.addListener=function(a,b,c){google.maps.event.addListener(a,b,c)},this.addListenerOnce=function(a,b,c){google.maps.event.addListenerOnce(a,b,c)},this.mapTrigger=function(a){google.maps.event.trigger(this._map,a)},this.trigger=function(a,b){google.maps.event.trigger(a,b)},this._newElement=function(a,b){if("marker"===a){if(!(b.position instanceof google.maps.LatLng))throw"markerOptions did not contain a position";return new d.markerConstructor(b)}if("polyline"===a){if(!(b.path instanceof Array))throw"polylineOptions did not contain a path";return new d.polylineConstructor(b)}throw"unrecognized type "+a},this._getElements=function(a){return a in this._elements||(this._elements[a]={}),this._elements[a]},this.addElement=function(a,b,c,d){if(i(a,"type"),i(b,"scopeId"),i(c,"id"),i(d,"elementOptions"),this.hasElement(a,b,c))return!1;var e=this._getElements(a);null==e[b]&&(e[b]={});var f={};angular.extend(f,d);var g=this._newElement(a,f);return e[b][c]=g,g.setMap(this._map),!0},this.updateElement=function(a,b,c,d){i(a,"type"),i(b,"scopeId"),i(c,"id"),i(d,"elementOptions");var e=this.getElement(a,b,c);return e?(e.setOptions(d),!0):!1},this.hasElement=function(a,b,c){return i(a,"type"),i(b,"scopeId"),i(c,"id"),null!=this.getElement(a,b,c)},this.getElement=function(a,b,c){i(a,"type"),i(b,"scopeId"),i(c,"id");var d=this._getElements(a);return null!=d[b]&&c in d[b]?d[b][c]:null},this.removeElement=function(a,b,c){i(a,"type"),i(b,"scopeId"),i(c,"id");var d=this._getElements(a),e=!1,f=d[b][c];return f&&(f.setMap(null),e=!0),d[b][c]=null,delete d[b][c],e},this.forEachElement=function(a,b){i(a,"type"),i(b,"fn");var c=this._getElements(a),d=Object.keys(c),e=d.reduce(function(a,b){return angular.forEach(c[b],function(b){a.push(b)}),a},[]);angular.forEach(e,function(a,c){null!=a&&b(a,c)})},this.forEachElementInScope=function(a,b,c){i(a,"type"),i(b,"scopeId"),i(c,"fn");var d=this._getElements(a);angular.forEach(d[b],function(a,b){null!=a&&c(a,b)})},this.getMap=function(){return this._map},angular.bind(this,j)(a,b)}])}();